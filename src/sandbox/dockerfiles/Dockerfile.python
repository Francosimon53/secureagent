# SecureAgent Sandbox - Python Runtime
# Minimal, secure Python 3.12 environment for sandboxed code execution
#
# Security features:
# - Distroless base image (no shell, minimal attack surface)
# - Non-root user (nobody:nogroup)
# - Read-only filesystem compatible
# - No network utilities
# - Minimal Python installation

FROM python:3.12-slim-bookworm AS builder

# Install only essential packages
RUN pip install --no-cache-dir --target=/app/packages \
    numpy==1.26.4 \
    pandas==2.2.0 \
    requests==2.31.0 \
    python-dateutil==2.8.2 \
    pytz==2024.1

# =============================================================================
# Production Image
# =============================================================================
FROM python:3.12-slim-bookworm

# Security: Remove unnecessary packages and files
RUN apt-get update && \
    apt-get purge -y --auto-remove \
        curl wget netcat-* telnet ftp ssh \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
    rm -rf /usr/share/doc /usr/share/man /usr/share/info

# Copy installed packages
COPY --from=builder /app/packages /usr/local/lib/python3.12/site-packages/

# Create sandbox directory
RUN mkdir -p /sandbox /tmp/sandbox && \
    chmod 755 /sandbox && \
    chmod 1777 /tmp/sandbox

# Set working directory
WORKDIR /sandbox

# Security: Run as nobody user
USER 65534:65534

# Environment
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONHASHSEED=random \
    HOME=/tmp/sandbox

# Default command (will be overridden)
CMD ["python3", "-c", "print('Sandbox ready')"]
